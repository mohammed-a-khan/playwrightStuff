ApiSteps.java
------------------

package com.qaf.framework.stepdefs;

import static org.testng.Assert.*;

import java.util.HashMap;
import java.util.Map;

import com.qaf.framework.util.ApiResponse;
import com.qaf.framework.util.TestContextManager;
import com.qmetry.qaf.automation.step.QAFTestStep;
import com.qmetry.qaf.automation.util.Reporter;
import com.qaf.framework.util.ApiClientUtil;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

/**
 * Base step definitions for API testing.
 * Provides common functionality for all API tests.
 */
public class ApiSteps {
    
    private static final Log logger = LogFactory.getLog(ApiSteps.class);
    
    /**
     * Get the current API response from context
     */
    protected ApiResponse getResponse() {
        return TestContextManager.getApiResponse();
    }
    
    /**
     * Set the current API response in context
     */
    protected void setResponse(ApiResponse response) {
        TestContextManager.setApiResponse(response);
    }
    
    /**
     * Sends a request to an endpoint with a payload file.
     * 
     * @param method HTTP method (GET, POST, PUT, DELETE)
     * @param endpoint API endpoint
     * @param payloadFile payload file name
     * @throws Exception if an error occurs
     */
    @QAFTestStep(description = "I send a {string} request to {string} with payload {string}")
    public void sendRequestWithPayload(String method, String endpoint, String payloadFile) throws Exception {
        logger.info("Sending " + method + " request to " + endpoint + " with payload " + payloadFile);
        
        try {
            String payload = ApiClientUtil.readPayload(payloadFile);
            ApiResponse response = null;
            
            switch (method.toUpperCase()) {
                case "GET":
                    response = ApiClientUtil.sendGetRequest(endpoint, new HashMap<>());
                    break;
                case "POST":
                    response = ApiClientUtil.sendPostRequest(endpoint, payload, new HashMap<>());
                    break;
                case "PUT":
                    response = ApiClientUtil.sendPutRequest(endpoint, payload, new HashMap<>());
                    break;
                case "DELETE":
                    response = ApiClientUtil.sendDeleteRequest(endpoint, new HashMap<>());
                    break;
                default:
                    throw new IllegalArgumentException("Unsupported HTTP method: " + method);
            }
            
            // Store the response in context
            setResponse(response);
            
            Reporter.log("Request sent successfully");
            Reporter.log("Response status: " + response.getStatusCode());
            Reporter.log("Response body: " + response.getResponseBody());
            
        } catch (Exception e) {
            logger.error("Error sending request: " + e.getMessage(), e);
            Reporter.log("Error sending request: " + e.getMessage());
            throw e;
        }
    }
    
    /**
     * Verifies that the response status code matches the expected value.
     * 
     * @param expectedStatus the expected HTTP status code
     */
    @QAFTestStep(description = "the response status code should be {expectedStatus}")
    public void verifyStatusCode(int expectedStatus) {
        ApiResponse response = getResponse();
        if (response == null) {
            fail("No response available. Make sure to send a request first.");
            return;
        }
        
        Reporter.log("Verifying status code: expected=" + expectedStatus + ", actual=" + response.getStatusCode());
        assertEquals(response.getStatusCode(), expectedStatus, "Response status code mismatch");
    }
    
    /**
     * Verifies that the response contains the specified text.
     * 
     * @param text the text to check for
     */
    @QAFTestStep(description = "the response should contain {string}")
    public void responseShouldContain(String text) {
        ApiResponse response = getResponse();
        if (response == null) {
            fail("No response available. Make sure to send a request first.");
            return;
        }
        
        Reporter.log("Verifying response contains: " + text);
        assertTrue(response.responseContains(text), "Response does not contain: " + text);
    }
    
    /**
     * Verifies that the response contains the specified field.
     * 
     * @param field the field to check for
     */
    @QAFTestStep(description = "the response should contain field {string}")
    public void responseShouldContainField(String field) {
        ApiResponse response = getResponse();
        if (response == null) {
            fail("No response available. Make sure to send a request first.");
            return;
        }
        
        Reporter.log("Verifying response contains field: " + field);
        assertTrue(response.hasJsonField(field), "Response does not contain field: " + field);
    }
    
    /**
     * Verifies that the response field has the expected value.
     * 
     * @param field the field to check
     * @param expectedValue the expected value
     */
    @QAFTestStep(description = "the response field {string} should be {string}")
    public void fieldShouldHaveValue(String field, String expectedValue) {
        ApiResponse response = getResponse();
        if (response == null) {
            fail("No response available. Make sure to send a request first.");
            return;
        }
        
        String actualValue = response.getValueFromJson(field);
        Reporter.log("Verifying field " + field + ": expected=" + expectedValue + ", actual=" + actualValue);
        assertEquals(actualValue, expectedValue, "Field value mismatch for: " + field);
    }
    
    /**
     * Verifies that the response field contains the expected text.
     * 
     * @param field the field to check
     * @param expectedText the text that should be contained
     */
    @QAFTestStep(description = "the response field {string} should contain {string}")
    public void fieldShouldContain(String field, String expectedText) {
        ApiResponse response = getResponse();
        if (response == null) {
            fail("No response available. Make sure to send a request first.");
            return;
        }
        
        String actualValue = response.getValueFromJson(field);
        Reporter.log("Verifying field " + field + " contains: " + expectedText);
        assertTrue(actualValue != null && actualValue.contains(expectedText), 
                  "Field " + field + " does not contain: " + expectedText);
    }
    
    /**
     * Adds a key-value pair to the test data map.
     * 
     * @param key the key
     * @param value the value
     */
    @QAFTestStep(description = "I set {string} to {string} in test data")
    public void setTestData(String key, String value) {
        TestContextManager.setTestData(key, value);
        Reporter.log("Set test data: " + key + "=" + value);
    }
    
    /**
     * Clears all test data.
     */
    @QAFTestStep(description = "I clear all test data")
    public void clearTestData() {
        TestContextManager.clearTestData();
        Reporter.log("Cleared all test data");
    }
    
    /**
     * Verifies that the response is successful (status code 2xx).
     */
    @QAFTestStep(description = "the response should be successful")
    public void responseShouldBeSuccessful() {
        ApiResponse response = getResponse();
        if (response == null) {
            fail("No response available. Make sure to send a request first.");
            return;
        }
        
        Reporter.log("Verifying response is successful");
        assertTrue(response.isSuccessful(), "Response is not successful. Status code: " + response.getStatusCode());
    }
    
    /**
     * Verifies that the response contains a non-empty array field.
     * 
     * @param arrayField the array field to check
     */
    @QAFTestStep(description = "the response should contain a non-empty {string} array")
    public void responseShouldContainNonEmptyArray(String arrayField) {
        ApiResponse response = getResponse();
        if (response == null) {
            fail("No response available. Make sure to send a request first.");
            return;
        }
        
        int arraySize = response.getArraySize(arrayField);
        Reporter.log("Verifying array " + arrayField + " is non-empty. Size: " + arraySize);
        assertTrue(arraySize > 0, "Array " + arrayField + " is empty or not found");
    }
    
    /**
     * Verifies that the array field has the expected size.
     * 
     * @param arrayField the array field to check
     * @param expectedSize the expected size
     */
    @QAFTestStep(description = "the {string} array should have size {int}")
    public void arrayShouldHaveSize(String arrayField, int expectedSize) {
        ApiResponse response = getResponse();
        if (response == null) {
            fail("No response available. Make sure to send a request first.");
            return;
        }
        
        int actualSize = response.getArraySize(arrayField);
        Reporter.log("Verifying array " + arrayField + " size: expected=" + expectedSize + ", actual=" + actualSize);
        assertEquals(actualSize, expectedSize, "Array size mismatch for: " + arrayField);
    }
    
    /**
     * Shows the current test data (for debugging).
     */
    @QAFTestStep(description = "I print all test data for debugging")
    public void printAllTestData() {
        Map<String, Object> data = TestContextManager.getTestData();
        Reporter.log("=== Current Test Data ===");
        for (Map.Entry<String, Object> entry : data.entrySet()) {
            Reporter.log(entry.getKey() + " = " + entry.getValue());
        }
    }
}

AssetLayoutSteps.java
------------------------

package com.qaf.framework.stepdefs;

import static org.testng.Assert.*;

import java.util.HashMap;
import java.util.Map;

import com.qaf.framework.util.ApiResponse;
import com.qaf.framework.util.TestContextManager;
import com.qmetry.qaf.automation.step.QAFTestStep;
import com.qmetry.qaf.automation.util.Reporter;
import com.qaf.framework.service.AssetLayoutService;
import com.qaf.framework.util.ApiClientUtil;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.json.JSONObject;

/**
 * Step definitions specifically for Asset Layout API testing.
 */
public class AssetLayoutSteps extends ApiSteps {
    
    private static final Log logger = LogFactory.getLog(AssetLayoutSteps.class);
    private static final String ASSET_LAYOUT_ENDPOINT = "/api/v1/spc/assetlayout";
    
    /**
     * Get or create the AssetLayoutService from context
     */
    protected AssetLayoutService getAssetLayoutService() {
        AssetLayoutService service = TestContextManager.getService(AssetLayoutService.class);
        if (service == null) {
            service = new AssetLayoutService();
            TestContextManager.setService(AssetLayoutService.class, service);
        }
        return service;
    }
    
    /**
     * Adds a header to the Asset Layout service.
     * 
     * @param headerName the header name
     * @param headerValue the header value
     */
    @QAFTestStep(description = "I add header {string} with value {string}")
    public void addHeader(String headerName, String headerValue) {
        getAssetLayoutService().addHeader(headerName, headerValue);
        Reporter.log("Added header: " + headerName + "=" + headerValue);
    }
    
    /**
     * Sends a request to the Asset Layout API with a payload file.
     * 
     * @param payloadFile the payload file name
     * @throws Exception if an error occurs
     */
    @QAFTestStep(description = "I send a request to the Asset Layout API with payload {string}")
    public void sendAssetLayoutRequestWithFile(String payloadFile) throws Exception {
        sendRequestWithPayload("POST", ASSET_LAYOUT_ENDPOINT, payloadFile);
    }
    
    /**
     * Sends a request to the Asset Layout API with deal ID, report date, and options.
     * 
     * @param dealId the deal ID
     * @param reportDate the report date
     * @param includeHistory whether to include history
     * @throws Exception if an error occurs
     */
    @QAFTestStep(description = "I send a request to the Asset Layout API with deal {string}, report date {string}, and includeHistory {boolean}")
    public void sendAssetLayoutRequestWithOptions(String dealId, String reportDate, boolean includeHistory) throws Exception {
        logger.info("Sending Asset Layout request with options");
        
        Map<String, Object> data = new HashMap<>();
        data.put("dealId", dealId);
        data.put("reportDate", reportDate);
        
        Map<String, Object> options = new HashMap<>();
        options.put("includeHistory", includeHistory);
        data.put("options", options);
        
        try {
            ApiResponse response = getAssetLayoutService().submitRequest(data);
            
            // Store response in context
            setResponse(response);
            
            Reporter.log("Asset Layout request with options sent successfully");
            Reporter.log("Response status: " + response.getStatusCode());
            Reporter.log("Response body: " + response.getResponseBody());
            
        } catch (Exception e) {
            logger.error("Error sending Asset Layout request: " + e.getMessage(), e);
            Reporter.log("Error sending Asset Layout request: " + e.getMessage());
            throw e;
        }
    }
    
    /**
     * Sends a request to the Asset Layout API with deal ID and report date.
     * 
     * @param dealId the deal ID
     * @param reportDate the report date
     * @throws Exception if an error occurs
     */
    @QAFTestStep(description = "I send a request to Asset Layout API with deal {string} and report date {string}")
    public void sendAssetLayoutRequest(String dealId, String reportDate) throws Exception {
        logger.info("Sending Asset Layout request with dealId: " + dealId + ", reportDate: " + reportDate);
        
        try {
            ApiResponse response = getAssetLayoutService().submitRequest(dealId, reportDate);
            
            // Store the response in context
            setResponse(response);
            
            Reporter.log("Asset Layout request sent successfully");
            Reporter.log("Response status: " + response.getStatusCode());
            Reporter.log("Response body: " + response.getResponseBody());
            
        } catch (Exception e) {
            logger.error("Error sending Asset Layout request: " + e.getMessage(), e);
            Reporter.log("Error sending Asset Layout request: " + e.getMessage());
            throw e;
        }
    }
    
    /**
     * Sends a request to the Asset Layout API with test data.
     * 
     * @throws Exception if an error occurs
     */
    @QAFTestStep(description = "I send a request to Asset Layout API with test data")
    public void sendAssetLayoutRequestWithTestData() throws Exception {
        Map<String, Object> testData = TestContextManager.getTestData();
        logger.info("Sending Asset Layout request with test data: " + testData);
        
        // Check if test data is empty and add required fields if needed
        if (testData.isEmpty()) {
            logger.warn("Test data is empty. Adding default values.");
            testData.put("messageId", ApiClientUtil.generateMessageId());
            testData.put("dealId", "838438"); // Default deal ID
            testData.put("reportDate", "2024-12-09"); // Default report date
        } else {
            // Ensure messageId is present
            if (!testData.containsKey("messageId")) {
                testData.put("messageId", ApiClientUtil.generateMessageId());
            }
            
            // Validate required fields
            if (!testData.containsKey("dealId") || !testData.containsKey("reportDate")) {
                logger.warn("Required fields missing in test data. Adding defaults.");
                if (!testData.containsKey("dealId")) {
                    testData.put("dealId", "838438"); // Default deal ID
                }
                if (!testData.containsKey("reportDate")) {
                    testData.put("reportDate", "2024-12-09"); // Default report date
                }
            }
        }
        
        try {
            ApiResponse response = getAssetLayoutService().submitRequest(testData);
            
            // Store the response in context
            setResponse(response);
            
            Reporter.log("Asset Layout request sent successfully");
            Reporter.log("Response status: " + response.getStatusCode());
            Reporter.log("Response body: " + response.getResponseBody());
            
        } catch (Exception e) {
            logger.error("Error sending Asset Layout request: " + e.getMessage(), e);
            Reporter.log("Error sending Asset Layout request: " + e.getMessage());
            throw e;
        }
    }
    
    /**
     * Sends a request to the Asset Layout API with a payload file.
     * 
     * @param payloadFile the payload file name
     * @throws Exception if an error occurs
     */
    @QAFTestStep(description = "I send a request to Asset Layout API with payload file {string}")
    public void sendAssetLayoutRequestWithPayloadFile(String payloadFile) throws Exception {
        logger.info("Sending Asset Layout request with payload file: " + payloadFile);
        
        try {
            ApiResponse response = getAssetLayoutService().submitRequestWithPayloadFile(payloadFile);
            
            // Store the response in context
            setResponse(response);
            
            Reporter.log("Asset Layout request sent successfully");
            Reporter.log("Response status: " + response.getStatusCode());
            Reporter.log("Response body: " + response.getResponseBody());
            
        } catch (Exception e) {
            logger.error("Error sending Asset Layout request: " + e.getMessage(), e);
            Reporter.log("Error sending Asset Layout request: " + e.getMessage());
            throw e;
        }
    }
    
    /**
     * Sends a request to the Asset Layout API with advanced options.
     * 
     * @param dealId the deal ID
     * @param reportDate the report date
     * @param includeHistory whether to include history
     * @param detailedView whether to use detailed view
     * @throws Exception if an error occurs
     */
    @QAFTestStep(description = "I send an advanced request to Asset Layout API with deal {string}, report date {string}, includeHistory {boolean}, and detailedView {boolean}")
    public void sendAdvancedAssetLayoutRequest(String dealId, String reportDate, boolean includeHistory, boolean detailedView) throws Exception {
        logger.info("Sending advanced Asset Layout request");
        
        try {
            ApiResponse response = getAssetLayoutService().submitAdvancedRequest(dealId, reportDate, includeHistory, detailedView);
            
            // Store the response in context
            setResponse(response);
            
            Reporter.log("Advanced Asset Layout request sent successfully");
            Reporter.log("Response status: " + response.getStatusCode());
            Reporter.log("Response body: " + response.getResponseBody());
            
        } catch (Exception e) {
            logger.error("Error sending advanced Asset Layout request: " + e.getMessage(), e);
            Reporter.log("Error sending advanced Asset Layout request: " + e.getMessage());
            throw e;
        }
    }
    
    /**
     * Verifies that the response contains asset data.
     */
    @QAFTestStep(description = "the response should contain asset data")
    public void responseShouldContainAssetData() {
        ApiResponse response = getResponse();
        if (response == null) {
            fail("No response available. Make sure to send a request first.");
            return;
        }
        
        Reporter.log("Verifying response contains asset data");
        assertTrue(response.hasJsonField("assets"), "Response does not contain assets field");
        assertTrue(response.getArraySize("assets") > 0, "Assets array is empty");
    }
    
    /**
     * Verifies that the asset with the specified ID exists in the response.
     * 
     * @param assetId the asset ID to check for
     */
    @QAFTestStep(description = "the response should contain asset with ID {string}")
    public void responseShouldContainAssetWithId(String assetId) {
        ApiResponse response = getResponse();
        if (response == null) {
            fail("No response available. Make sure to send a request first.");
            return;
        }
        
        Reporter.log("Verifying response contains asset with ID: " + assetId);
        
        boolean found = false;
        int assetCount = response.getArraySize("assets");
        
        for (int i = 0; i < assetCount; i++) {
            try {
                JSONObject asset = response.getArrayItem("assets", i);
                String currentId = asset.has("assetId") ? asset.getString("assetId") : "";
                if (assetId.equals(currentId)) {
                    found = true;
                    break;
                }
            } catch (Exception e) {
                // Continue checking
                logger.debug("Error checking asset ID: " + e.getMessage());
            }
        }
        
        assertTrue(found, "Asset with ID " + assetId + " not found in response");
    }
    
    /**
     * Verifies that the response contains the specified layout type.
     * 
     * @param layoutType the layout type to check for
     */
    @QAFTestStep(description = "the response should contain layout type {string}")
    public void responseShouldContainLayoutType(String layoutType) {
        ApiResponse response = getResponse();
        if (response == null) {
            fail("No response available. Make sure to send a request first.");
            return;
        }
        
        Reporter.log("Verifying response contains layout type: " + layoutType);
        
        boolean found = false;
        int layoutCount = response.getArraySize("layout");
        
        for (int i = 0; i < layoutCount; i++) {
            try {
                JSONObject layout = response.getArrayItem("layout", i);
                String currentType = layout.has("type") ? layout.getString("type") : "";
                if (layoutType.equals(currentType)) {
                    found = true;
                    break;
                }
            } catch (Exception e) {
                // Continue checking
                logger.debug("Error checking layout type: " + e.getMessage());
            }
        }
        
        assertTrue(found, "Layout type " + layoutType + " not found in response");
    }
    
    /**
     * Sets up a basic asset layout test data.
     * 
     * @param dealId the deal ID
     * @param reportDate the report date
     */
    @QAFTestStep(description = "I set up basic asset layout test data with deal {string} and report date {string}")
    public void setupBasicAssetLayoutTestData(String dealId, String reportDate) {
        // Clear existing test data
        TestContextManager.clearTestData();
        
        // Set new test data values
        TestContextManager.setTestData("dealId", dealId);
        TestContextManager.setTestData("reportDate", reportDate);
        TestContextManager.setTestData("messageId", ApiClientUtil.generateMessageId());
        
        logger.info("Set up basic asset layout test data: dealId=" + dealId + ", reportDate=" + reportDate);
        Reporter.log("Set up basic asset layout test data with dealId=" + dealId + ", reportDate=" + reportDate);
        
        // Debug log to verify test data is stored
        Map<String, Object> testData = TestContextManager.getTestData();
        logger.info("Verification - Current test data: " + testData);
    }
    
    /**
     * Dumps the current test data for debugging.
     */
    @QAFTestStep(description = "I verify asset layout test data")
    public void verifyAssetLayoutTestData() {
        Map<String, Object> testData = TestContextManager.getTestData();
        
        Reporter.log("=== Asset Layout Test Data ===");
        Reporter.log("Deal ID: " + testData.getOrDefault("dealId", "NOT SET"));
        Reporter.log("Report Date: " + testData.getOrDefault("reportDate", "NOT SET"));
        Reporter.log("Message ID: " + testData.getOrDefault("messageId", "NOT SET"));
        
        // Also verify in logs for debugging
        logger.info("Verification - Deal ID: " + testData.getOrDefault("dealId", "NOT SET"));
        logger.info("Verification - Report Date: " + testData.getOrDefault("reportDate", "NOT SET"));
        logger.info("Verification - Message ID: " + testData.getOrDefault("messageId", "NOT SET"));
    }
}

package com.qaf.framework.stepdefs;

import static org.testng.Assert.*;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.qaf.framework.util.ApiResponse;
import com.qaf.framework.util.TestContextManager;
import com.qmetry.qaf.automation.step.QAFTestStep;
import com.qmetry.qaf.automation.util.Reporter;
import com.qmetry.qaf.automation.util.Validator;
import com.qaf.framework.service.DealStaticInfoService;
import com.qaf.framework.util.ApiClientUtil;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.json.JSONArray;
import org.json.JSONObject;

/**
 * Step definitions for Deal Static Info API testing.
 */
public class DealStaticInfoSteps extends ApiSteps {
    
    private static final Log logger = LogFactory.getLog(DealStaticInfoSteps.class);
    private static final String EXPECTED_DEAL_INFO_KEY = "expected.deal.info";
    private static final String DEAL_STATIC_INFO_ENDPOINT = "/api/v1/abo/dealstaticinfo";
    
    /**
     * Get or create the DealStaticInfoService from context
     */
    protected DealStaticInfoService getDealStaticInfoService() {
        DealStaticInfoService service = TestContextManager.getService(DealStaticInfoService.class);
        if (service == null) {
            service = new DealStaticInfoService();
            TestContextManager.setService(DealStaticInfoService.class, service);
        }
        return service;
    }
    
    /**
     * Sends a request to the Deal Static Info API with the specified deal ID.
     * 
     * @param dealId the deal ID
     * @throws Exception if an error occurs
     */
    @QAFTestStep(description = "I send a request to Deal Static Info API for deal {dealId}")
    public void sendDealStaticInfoRequest(String dealId) throws Exception {
        logger.info("Sending Deal Static Info request for dealId: " + dealId);
        
        try {
            ApiResponse response = getDealStaticInfoService().getDealStaticInfo(dealId);
            
            // Store the response in context
            setResponse(response);
            
            Reporter.log("Deal Static Info request sent successfully");
            Reporter.log("Response status: " + response.getStatusCode());
            Reporter.log("Response body: " + response.getResponseBody());
            
        } catch (Exception e) {
            logger.error("Error sending Deal Static Info request: " + e.getMessage(), e);
            Reporter.log("Error sending Deal Static Info request: " + e.getMessage());
            throw e;
        }
    }
    
    /**
     * Sends a request to the Deal Static Info API with the specified data.
     * 
     * @param data the request data
     * @throws Exception if an error occurs
     */
    @QAFTestStep(description = "I send a request to Deal Static Info API with data {data}")
    public void sendDealStaticInfoRequestWithData(Map<String, Object> data) throws Exception {
        logger.info("Sending Deal Static Info request with data: " + data);
        
        try {
            ApiResponse response = getDealStaticInfoService().getDealStaticInfo(data);
            
            // Store the response in context
            setResponse(response);
            
            Reporter.log("Deal Static Info request sent successfully");
            Reporter.log("Response status: " + response.getStatusCode());
            Reporter.log("Response body: " + response.getResponseBody());
            
        } catch (Exception e) {
            logger.error("Error sending Deal Static Info request: " + e.getMessage(), e);
            Reporter.log("Error sending Deal Static Info request: " + e.getMessage());
            throw e;
        }
    }

    /**
     * Sends a request to Deal Static Info API using a payload file.
     * 
     * @param payloadFile name of the payload file
     * @throws Exception if an error occurs
     */
    @QAFTestStep(description = "I send a request to Deal Static Info API with payload file {payloadFile}")
    public void sendDealStaticInfoRequestWithPayloadFile(String payloadFile) throws Exception {
        logger.info("Sending Deal Static Info request with payload file: " + payloadFile);
        
        try {
            // Read the payload file
            String payload = ApiClientUtil.readPayload(payloadFile);
            
            // Process the payload with test data
            Map<String, Object> testData = TestContextManager.getTestData();
            payload = processPayloadWithTestData(payload, testData);
            
            logger.info("Processed payload: " + payload);
            
            // Send the request
            Map<String, String> headers = new HashMap<>();
            headers.put("Content-Type", "application/json");
            ApiResponse response = ApiClientUtil.sendPostRequest(DEAL_STATIC_INFO_ENDPOINT, payload, headers);
            
            // Store the response in context
            setResponse(response);
            
            Reporter.log("Deal Static Info request sent successfully");
            Reporter.log("Response status: " + response.getStatusCode());
            Reporter.log("Response body: " + response.getResponseBody());
            
        } catch (Exception e) {
            logger.error("Error sending Deal Static Info request: " + e.getMessage(), e);
            Reporter.log("Error sending Deal Static Info request: " + e.getMessage());
            throw e;
        }
    }
    
    /**
     * Processes a payload template by replacing variables with test data.
     * Handles special cases like numeric values needing to be unquoted.
     * 
     * @param payload the payload template
     * @param testData the test data
     * @return the processed payload
     */
    private String processPayloadWithTestData(String payload, Map<String, Object> testData) {
        String processedPayload = payload;
        logger.info("Original payload template: " + payload);
        
        // Special case for scenario 2: Use nonExistentDealId instead of validDealId if testing non-existent deal
        if (payload.contains("${dealId}")) {
            String scenarioType = TestContextManager.getTestDataValueAsString("scenarioType");
            
            if ("nonExistent".equals(scenarioType) && testData.containsKey("nonExistentDealId")) {
                processedPayload = processedPayload.replace("${dealId}", testData.get("nonExistentDealId").toString());
                logger.info("Using nonExistentDealId for deal ID");
            } else if (testData.containsKey("validDealId")) {
                processedPayload = processedPayload.replace("${dealId}", testData.get("validDealId").toString());
                logger.info("Using validDealId for deal ID");
            }
        }
        
        // Replace messageId variable
        if (processedPayload.contains("${messageId}") && testData.containsKey("validMessageId")) {
            processedPayload = processedPayload.replace("${messageId}", testData.get("validMessageId").toString());
        }
        
        // Handle other variables from test data
        for (Map.Entry<String, Object> entry : testData.entrySet()) {
            String key = entry.getKey();
            Object value = entry.getValue();
            String placeholder = "${" + key + "}";
            
            if (processedPayload.contains(placeholder) && value != null) {
                // Handle numeric values (numbers should not be quoted in JSON)
                if (value instanceof Number) {
                    // Check if the placeholder is within quotes in the template
                    if (processedPayload.contains("\"" + placeholder + "\"")) {
                        processedPayload = processedPayload.replace("\"" + placeholder + "\"", value.toString());
                    } else {
                        processedPayload = processedPayload.replace(placeholder, value.toString());
                    }
                } else {
                    // For string values, regular replacement is fine
                    processedPayload = processedPayload.replace(placeholder, value.toString());
                }
            }
        }
        
        logger.info("Processed payload: " + processedPayload);
        return processedPayload;
    }
    
    /**
     * Sends a raw request to Deal Static Info API with the specified payload.
     * Manually substitutes any remaining variables in the payload.
     * 
     * @param payload the raw JSON payload as a string
     * @throws Exception if an error occurs
     */
    @QAFTestStep(description = "I send a raw request to Deal Static Info API with payload: {payload}")
    public void sendRawDealStaticInfoRequest(String payload) throws Exception {
        logger.info("Original payload before substitution: " + payload);
        
        // Get variables from TestContext to perform manual substitution
        @SuppressWarnings("unchecked")
        Map<String, Object> testData = TestContextManager.getTestData();
        
        // Replace known variables that might not have been substituted
        if (payload.contains("${validMessageId}") && testData.containsKey("validMessageId")) {
            payload = payload.replace("${validMessageId}", testData.get("validMessageId").toString());
        }
        
        if (payload.contains("${validDealId}") && testData.containsKey("validDealId")) {
            payload = payload.replace("${validDealId}", testData.get("validDealId").toString());
        }
        
        if (payload.contains("${nonExistentDealId}") && testData.containsKey("nonExistentDealId")) {
            payload = payload.replace("${nonExistentDealId}", testData.get("nonExistentDealId").toString());
        }
        
        logger.info("Processed payload after substitution: " + payload);
        
        try {
            Map<String, String> headers = new HashMap<>();
            headers.put("Content-Type", "application/json");
            ApiResponse response = ApiClientUtil.sendPostRequest(DEAL_STATIC_INFO_ENDPOINT, payload, headers);
            
            // Store the response in context
            setResponse(response);
            
            Reporter.log("Raw Deal Static Info request sent successfully");
            Reporter.log("Response status: " + response.getStatusCode());
            Reporter.log("Response body: " + response.getResponseBody());
            
        } catch (Exception e) {
            logger.error("Error sending raw Deal Static Info request: " + e.getMessage(), e);
            Reporter.log("Error sending raw Deal Static Info request: " + e.getMessage());
            throw e;
        }
    }
    
    /**
     * Sets the scenario type for test data processing.
     * 
     * @param scenarioType type of scenario (valid, nonExistent, etc.)
     */
    @QAFTestStep(description = "I set scenario type to {scenarioType}")
    public void setScenarioType(String scenarioType) {
        TestContextManager.setTestData("scenarioType", scenarioType);
        logger.info("Scenario type set to: " + scenarioType);
        Reporter.log("Scenario type set to: " + scenarioType);
    }
    
    /**
     * Sends a request to Deal Static Info API with a specific deal ID and nonExistent as true/false.
     * 
     * @param dealIdType type of deal ID to use (valid or nonExistent)
     * @throws Exception if an error occurs
     */
    @QAFTestStep(description = "I send a request to Deal Static Info API with {dealIdType} deal ID")
    public void sendDealStaticInfoRequestWithDealIdType(String dealIdType) throws Exception {
        // Set the scenario type first
        setScenarioType(dealIdType);
        
        Map<String, Object> testData = TestContextManager.getTestData();
        String payloadFile = "DealStaticInfo_payload.json";
        
        // Determine which deal ID to use
        String dealIdKey = "validDealId";
        if ("nonExistent".equalsIgnoreCase(dealIdType)) {
            dealIdKey = "nonExistentDealId";
        }
        
        if (!testData.containsKey(dealIdKey)) {
            Reporter.log("Required test data missing: " + dealIdKey, "fail");
            fail("Required test data missing: " + dealIdKey);
            return;
        }
        
        // Read the payload file
        String payload = ApiClientUtil.readPayload(payloadFile);
        
        // Replace the dealId variable with the appropriate value
        payload = payload.replace("${dealId}", testData.get(dealIdKey).toString());
        
        // Replace the messageId variable if present
        if (testData.containsKey("validMessageId")) {
            payload = payload.replace("${messageId}", testData.get("validMessageId").toString());
        } else {
            payload = payload.replace("${messageId}", ApiClientUtil.generateMessageId());
        }
        
        logger.info("Processed payload: " + payload);
        
        try {
            Map<String, String> headers = new HashMap<>();
            headers.put("Content-Type", "application/json");
            ApiResponse response = ApiClientUtil.sendPostRequest(DEAL_STATIC_INFO_ENDPOINT, payload, headers);
            
            // Store the response in context
            setResponse(response);
            
            Reporter.log("Deal Static Info request sent successfully with " + dealIdType + " deal ID");
            Reporter.log("Response status: " + response.getStatusCode());
            Reporter.log("Response body: " + response.getResponseBody());
            
        } catch (Exception e) {
            logger.error("Error sending Deal Static Info request: " + e.getMessage(), e);
            Reporter.log("Error sending Deal Static Info request: " + e.getMessage());
            throw e;
        }
    }
    
    /**
     * Sends a request to Deal Static Info API with no body.
     * 
     * @throws Exception if an error occurs
     */
    @QAFTestStep(description = "I send a request to Deal Static Info API with no body")
    public void sendEmptyDealStaticInfoRequest() throws Exception {
        logger.info("Sending Deal Static Info request with no body");
        
        try {
            Map<String, String> headers = new HashMap<>();
            headers.put("Content-Type", "application/json");
            ApiResponse response = ApiClientUtil.sendPostRequest(DEAL_STATIC_INFO_ENDPOINT, "", headers);
            
            // Store the response in context
            setResponse(response);
            
            Reporter.log("Empty Deal Static Info request sent successfully");
            Reporter.log("Response status: " + response.getStatusCode());
            Reporter.log("Response body: " + response.getResponseBody());
            
        } catch (Exception e) {
            logger.error("Error sending empty Deal Static Info request: " + e.getMessage(), e);
            Reporter.log("Error sending empty Deal Static Info request: " + e.getMessage());
            throw e;
        }
    }
    
    /**
     * Loads deal information from UI for a specific deal.
     * This is a placeholder method that would be replaced with actual UI automation.
     * 
     * @param dealId the deal ID to load information for
     */
    @QAFTestStep(description = "I load deal information from UI for deal {dealId}")
    public void loadDealInfoFromUI(String dealId) {
        logger.info("Loading deal information from UI for dealId: " + dealId);
        
        // Clear any existing deal info
        clearDealInfo();
        
        // This would be replaced with actual UI automation code
        // For now, we're simulating the process of gathering data from UI
        
        // Create a new record for this deal
        List<Map<String, String>> dealInfo = new ArrayList<>();
        Map<String, String> record = new HashMap<>();
        
        // In real implementation, these values would come from UI elements
        record.put("dealId", dealId);
        record.put("entityId", "808");
        record.put("dealKey", "some deal name");
        record.put("dealShortName", "some deal short name");
        record.put("closingDate", "2013-05-28");
        record.put("scheduledTerminationDate", "2030-05-28");
        record.put("scheduledFirstPaymentDate", "2013-08-28");
        
        dealInfo.add(record);
        
        // Store the deal info in test context
        TestContextManager.setContext(EXPECTED_DEAL_INFO_KEY, dealInfo);
        
        Reporter.log("Loaded deal information from UI for dealId: " + dealId);
        logger.info("Deal information loaded: " + dealInfo);
    }
    
    /**
     * Stores deal information from UI for later validation.
     * 
     * @param dealInfo the deal information gathered from UI
     */
    @QAFTestStep(description = "I store deal information from UI {dealInfo}")
    public void storeDealInfoFromUI(List<Map<String, String>> dealInfo) {
        logger.info("Storing deal information from UI: " + dealInfo);
        TestContextManager.setContext(EXPECTED_DEAL_INFO_KEY, dealInfo);
        Reporter.log("Stored deal information from UI with " + dealInfo.size() + " records");
    }
    
    /**
     * Adds a single deal information record from UI for later validation.
     * 
     * @param fieldName the field name
     * @param fieldValue the field value
     */
    @QAFTestStep(description = "I add deal information field {fieldName} with value {fieldValue}")
    public void addDealInfoField(String fieldName, String fieldValue) {
        @SuppressWarnings("unchecked")
        List<Map<String, String>> dealInfo = (List<Map<String, String>>) TestContextManager.getContext(EXPECTED_DEAL_INFO_KEY);
        
        if (dealInfo == null) {
            dealInfo = new ArrayList<>();
            Map<String, String> firstRecord = new HashMap<>();
            dealInfo.add(firstRecord);
        }
        
        Map<String, String> firstRecord = dealInfo.get(0);
        firstRecord.put(fieldName, fieldValue);
        
        TestContextManager.setContext(EXPECTED_DEAL_INFO_KEY, dealInfo);
        logger.info("Added deal information field: " + fieldName + "=" + fieldValue);
    }
    
    /**
     * Adds a completely new deal information record for later validation.
     */
    @QAFTestStep(description = "I add a new deal information record")
    public void addNewDealInfoRecord() {
        @SuppressWarnings("unchecked")
        List<Map<String, String>> dealInfo = (List<Map<String, String>>) TestContextManager.getContext(EXPECTED_DEAL_INFO_KEY);
        
        if (dealInfo == null) {
            dealInfo = new ArrayList<>();
        }
        
        dealInfo.add(new HashMap<>());
        TestContextManager.setContext(EXPECTED_DEAL_INFO_KEY, dealInfo);
        logger.info("Added new deal information record at index " + (dealInfo.size() - 1));
    }
    
    /**
     * Validates deal static information in response against UI data.
     */
    @QAFTestStep(description = "I validate deal static information against UI data")
    public void validateDealStaticInfo() {
        ApiResponse response = getResponse();
        if (response == null) {
            Reporter.log("No response available. Make sure to send a request first.", "fail");
            fail("No response available. Make sure to send a request first.");
            return;
        }
        
        @SuppressWarnings("unchecked")
        List<Map<String, String>> expectedDealInfo = (List<Map<String, String>>) TestContextManager.getContext(EXPECTED_DEAL_INFO_KEY);
        
        if (expectedDealInfo == null || expectedDealInfo.isEmpty()) {
            Reporter.log("No expected deal information available. Make sure to store UI data first.", "fail");
            fail("No expected deal information available. Make sure to store UI data first.");
            return;
        }
        
        JSONObject jsonResponse = response.getJsonObject();
        if (jsonResponse == null) {
            Reporter.log("Invalid JSON response", "fail");
            fail("Invalid JSON response");
            return;
        }
        
        // Check for errors in the response
        if (jsonResponse.has("errorMessage") && !jsonResponse.isNull("errorMessage")) {
            String errorMessage = jsonResponse.getString("errorMessage");
            if (errorMessage != null && !errorMessage.isEmpty()) {
                Reporter.log("API returned error: " + errorMessage, "fail");
                fail("API returned error: " + errorMessage);
                return;
            }
        }
        
        if (!jsonResponse.has("dealStaticInfo") || jsonResponse.isNull("dealStaticInfo")) {
            Reporter.log("Response does not contain dealStaticInfo", "fail");
            fail("Response does not contain dealStaticInfo");
            return;
        }
        
        JSONArray dealStaticInfo = jsonResponse.getJSONArray("dealStaticInfo");
        if (dealStaticInfo.length() == 0) {
            Reporter.log("dealStaticInfo array is empty", "fail");
            fail("dealStaticInfo array is empty");
            return;
        }
        
        // Validate each field in expected deal info against the response
        for (int i = 0; i < expectedDealInfo.size(); i++) {
            Map<String, String> expectedRecord = expectedDealInfo.get(i);
            
            // Check if we have corresponding record in the response
            if (i >= dealStaticInfo.length()) {
                Reporter.log("Expected deal record at index " + i + " not found in response", "fail");
                continue;
            }
            
            JSONObject actualRecord = dealStaticInfo.getJSONObject(i);
            
            // Validate each field
            for (Map.Entry<String, String> entry : expectedRecord.entrySet()) {
                String fieldName = entry.getKey();
                String expectedValue = entry.getValue();
                
                if (!actualRecord.has(fieldName)) {
                    Reporter.log("Field '" + fieldName + "' missing in response", "fail");
                    continue;
                }
                
                Object actualObj = actualRecord.get(fieldName);
                String actualValue = actualObj != null ? actualObj.toString() : "null";
                
                if (actualObj == JSONObject.NULL) {
                    actualValue = "null";
                }
                
                // Special case: Consider empty string and null as equal
                boolean isMatch = expectedValue.equals(actualValue) || 
                                 (expectedValue.isEmpty() && "null".equals(actualValue));
                
                if (isMatch) {
                    Reporter.log("Field '" + fieldName + "' matches expected value: " + 
                               (expectedValue.isEmpty() ? "[empty string]" : expectedValue));
                } else {
                    Reporter.log("Field '" + fieldName + "' mismatch - Expected: " + 
                               (expectedValue.isEmpty() ? "[empty string]" : expectedValue) + 
                               ", Actual: " + actualValue, "fail");
                }
            }
        }
    }
    
    /**
     * Adds all deal information fields from a map.
     * 
     * @param fieldValues map of field names to values
     */
    @QAFTestStep(description = "I add deal information fields {fieldValues}")
    public void addDealInfoFields(Map<String, String> fieldValues) {
        @SuppressWarnings("unchecked")
        List<Map<String, String>> dealInfo = (List<Map<String, String>>) TestContextManager.getContext(EXPECTED_DEAL_INFO_KEY);
        
        if (dealInfo == null) {
            dealInfo = new ArrayList<>();
            dealInfo.add(new HashMap<>());
        }
        
        Map<String, String> currentRecord = dealInfo.get(dealInfo.size() - 1);
        currentRecord.putAll(fieldValues);
        
        TestContextManager.setContext(EXPECTED_DEAL_INFO_KEY, dealInfo);
        logger.info("Added deal information fields: " + fieldValues);
    }
    
    /**
     * Clears all stored deal information.
     */
    @QAFTestStep(description = "I clear stored deal information")
    public void clearDealInfo() {
        TestContextManager.setContext(EXPECTED_DEAL_INFO_KEY, null);
        logger.info("Cleared stored deal information");
    }
}


