// IMPORTANT: Make sure the text matches EXACTLY what's in your feature file
When('I search for trades with following filters', async function(this: TestContext, dataTable) {
  if (!this.tradeApiClient) {
    throw new Error('Trade API client is not initialized');
  }
  
  try {
    // Load the JSON file
    const filePath = path.resolve(process.cwd(), 'requests', 'trade-search.json');
    const fileContent = fs.readFileSync(filePath, 'utf8');
    const requestData = JSON.parse(fileContent);
    
    // Apply dataTable overrides if present
    if (dataTable) {
      const filters = dataTable.rowsHash();
      for (const key of Object.keys(filters)) {
        if (key === 'accountNumFilter' || key === 'tradeStatusFilter' || key === 'tradeTypeFilter') {
          requestData[key] = filters[key].includes(',') ? filters[key].split(',') : filters[key];
        } 
        else if (key === 'priorityOrder') {
          requestData[key] = filters[key] === 'true';
        }
        else {
          requestData[key] = filters[key];
        }
      }
    }
    
    // Store for later use
    this.testData = this.testData || {};
    this.testData.tradeFilters = requestData;
    
    // Execute search with await
    const searchResult = await this.tradeApiClient.searchTrades(requestData);
    
    // Store response
    this.response = {
      data: searchResult,
      status: 200,
      statusText: 'OK',
      headers: {},
      config: {} as any
    };
  } catch (err) {
    const error = err as Error;
    if (axios.isAxiosError(error) && error.response) {
      this.response = error.response;
    } else {
      throw error;
    }
  }
});
